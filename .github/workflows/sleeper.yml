name: Sleeper sync

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      LEAGUES: "1265837618587762688 1181689020258160640"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Export each league
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs
          for LID in $LEAGUES; do
            echo ">> Export $LID"
            rm -rf ./docs/league_${LID}_*/
            python sleeper_sync.py --league "$LID" --out ./docs
          done

      - name: Publish and write diffs/manifests
        shell: bash
        run: |
          set -euo pipefail
          for LID in $LEAGUES; do
            RUN_DIR=$(ls -dtd ./docs/league_${LID}_*/ | head -n 1)
            STABLE_DIR=./docs/league_${LID}
            if [ -z "${RUN_DIR:-}" ]; then
              echo "::error::No per-run folder for $LID"
              exit 1
            fi

            # File-level diff BEFORE copying to stable
            if [ -d "$STABLE_DIR" ]; then
              python tools/postprocess.py --diff --old "$STABLE_DIR"_
